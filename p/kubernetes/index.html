<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><title>Kubernetes</title><link rel=canonical href=https://ilolicon.github.io/p/kubernetes/><link rel=stylesheet href=/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css><meta property="og:title" content="Kubernetes"><meta property="og:description" content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><meta property="og:url" content="https://ilolicon.github.io/p/kubernetes/"><meta property="og:site_name" content="ilolicon's Blog"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Cloud Native"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Pod"><meta property="article:tag" content="Service"><meta property="article:tag" content="Kubeadm"><meta property="article:published_time" content="2020-12-20T14:21:14+08:00"><meta property="article:modified_time" content="2020-12-20T14:21:14+08:00"><meta name=twitter:title content="Kubernetes"><meta name=twitter:description content="Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications."><link rel="shortcut icon" href=/img/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu96a5ab8e0364e843af4687201b687892_162934_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>ilolicon's Blog</a></h1><h2 class=site-description>Keep Calm and Carry On.</h2></div></header><ol class=social-menu><li><a href=https://github.com/ilolicon target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#容器编排>容器编排</a></li><li><a href=#kubernetes架构概述>Kubernetes架构概述</a></li><li><a href=#pod>Pod</a></li><li><a href=#service>Service</a></li><li><a href=#网络通信>网络通信</a></li><li><a href=#namespace>Namespace</a></li><li><a href=#初始化kubernetes集群>初始化Kubernetes集群</a></li><li><a href=#kuberntes资源概述>Kuberntes资源概述</a><ol><li><a href=#资源清单定义>资源清单定义</a></li><li><a href=#pod概述>Pod概述</a><ol><li><a href=#自主式pod>自主式Pod</a></li><li><a href=#pod资源>Pod资源</a></li><li><a href=#pod生命周期>Pod生命周期</a></li><li><a href=#pod容器探针类型>Pod容器探针类型</a></li><li><a href=#pod控制器>Pod控制器</a></li></ol></li><li><a href=#service概述>Service概述</a><ol><li><a href=#service代理>Service代理</a></li><li><a href=#service类型>Service类型</a></li><li><a href=#headless-services无头service>Headless Services(无头Service)</a></li></ol></li><li><a href=#ingress>Ingress</a></li><li><a href=#存储卷>存储卷</a><ol><li><a href=#pvpvc>PV/PVC</a></li><li><a href=#storageclass>StorageClass</a></li><li><a href=#configmap>ConfigMap</a></li><li><a href=#secret>Secret</a></li></ol></li></ol></li><li><a href=#statefulset控制器>StatefulSet控制器</a></li><li><a href=#认证及serviceaccount>认证及ServiceAccount</a><ol><li><a href=#认证授权>认证授权</a></li><li><a href=#serviceaccount>ServiceAccount</a></li><li><a href=#rbac授权>RBAC授权</a></li></ol></li><li><a href=#helm>Helm</a></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/cloudnative/ style=background-color:#2a9d8f;color:#fff>CloudNative</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/kubernetes/>Kubernetes</a></h2><h3 class=article-subtitle>Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 20, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><p><a class=link href=https://kubernetes.io/zh/docs/home/ target=_blank rel=noopener><img src=https://img.shields.io/badge/Kubernetes-README-356DE3 loading=lazy alt="kubernetes readme"></a></p><p><a class=link href=https://kubernetes.io/ target=_blank rel=noopener><img src=/p/kubernetes/icons/kubernetes.svg loading=lazy alt=kubernetes></a></p><p><code>container evolution</code></p><p><img src=/p/kubernetes/icons/container_evolution.svg loading=lazy alt=container_evolution></p><h2 id=容器编排>容器编排</h2><ul><li>Ansible/Saltstack <strong>传统应用</strong>编排工具</li><li>Docker<ul><li>docker compose(docker单机编排)</li><li>docker swarm(docker主机加入docker swarm资源池)</li><li>docker machine(完成docker主机加入docker swarm资源池的先决条件/预处理工具)</li></ul></li><li>Mesos(IDC OS) + marathon(面向容器编排的框架)</li><li>kubernetes(Borg)<ul><li>自动装箱(基于依赖 自动完成容器部署 不影响其可用性)</li><li>自我修复</li><li>水平扩展</li><li>服务发现和负载均衡</li><li>自动发布和回滚</li><li>密钥和配置管理</li><li>存储编排</li><li>任务批量处理运行</li></ul></li></ul><p>概念: <code>DevOps</code> <code>MicroServices</code> <code>Blockchain</code></p><ul><li>CI: 持续集成</li><li>CD: 持续交互 Delivery</li><li>CD: 持续部署 Deployment</li></ul><h2 id=kubernetes架构概述>Kubernetes架构概述</h2><p><img src=/p/kubernetes/icons/kubernetes_cluster.png width=576 height=335 srcset="/p/kubernetes/icons/kubernetes_cluster_hu5d0dab3c0d7d17e817e2f0f85b092344_117781_480x0_resize_box_3.png 480w, /p/kubernetes/icons/kubernetes_cluster_hu5d0dab3c0d7d17e817e2f0f85b092344_117781_1024x0_resize_box_3.png 1024w" loading=lazy alt=kubernetes-cluster class=gallery-image data-flex-grow=171 data-flex-basis=412px></p><ul><li>有中心节点的集群架构系统(抽象各主机资源 统一对外提供计算)</li><li>Master/Node(Worker)<ul><li>Master<ul><li>etcd: 兼具一致性和高可用性的键值数据库 可以作为保存Kubernetes所有集群数据的后台数据库</li><li>API Server(公开kubernetes API)</li><li>Scheduler(调度器)</li><li>Controller-Manager(控制器)<ul><li>节点控制器(Node Controller): 负责在节点出现故障时进行通知和响应</li><li>任务控制器(Job controller): 监测代表一次性任务的Job对象 然后创建Pods来运行这些任务直至完成</li><li>端点控制器(Endpoints Controller): 填充端点(Endpoints)对象(即加入Service与Pod)</li><li>服务帐户和令牌控制器(Service Account & Token Controllers): 为新的命名空间创建默认帐户和API访问令牌</li></ul></li></ul></li><li>Node<ul><li>kubelet: 集群代理 并不运行容器</li><li>kube-proxy: 网络代理 管理Service的创建 更新(iptables/ipvs)</li><li>容器运行时(容器引擎): 运行容器 支持<a class=link href=https://kubernetes.io/zh/docs/reference/kubectl/docker-cli-to-kubectl/ target=_blank rel=noopener>Docker</a>/<a class=link href=https://containerd.io/docs/ target=_blank rel=noopener>containerd</a>/<a class=link href=https://cri-o.io/#what-is-cri-o target=_blank rel=noopener>CRI-O</a>以及任何实现 <a class=link href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md target=_blank rel=noopener>Kubernetes CRI (容器运行环境接口)</a></li></ul></li></ul></li></ul><p><a class=link href=https://kubernetes.io/zh/docs/concepts/overview/components/ target=_blank rel=noopener>kubernetes组件</a></p><p><img src=/p/kubernetes/icons/kubernetes_cluster02.png width=821 height=568 srcset="/p/kubernetes/icons/kubernetes_cluster02_hu5ddc702c3d24b1f991acd583b33b036e_257528_480x0_resize_box_3.png 480w, /p/kubernetes/icons/kubernetes_cluster02_hu5ddc702c3d24b1f991acd583b33b036e_257528_1024x0_resize_box_3.png 1024w" loading=lazy alt=kuberbetes-cluster02 class=gallery-image data-flex-grow=144 data-flex-basis=346px></p><p><img src=/p/kubernetes/icons/components-of-kubernetes.svg loading=lazy alt=components-of-kubernetes></p><h2 id=pod>Pod</h2><ul><li>Pod<ul><li>自主式Pod</li><li>控制器管理的Pod(建议使用)<ul><li>ReplicationController(副本控制器)</li><li>ReplicaSet(副本集控制器 不直接使用 有一个声明式更新的控制器Deployment)</li><li>Deployment(管理无状态应用)<ul><li>HPA(HorizontalPodAutoscaler) 水平Pod自动伸缩控制器</li></ul></li><li>StatefulSet(有状态副本集)</li><li>DaemonSet</li><li>Job/CronJob</li></ul></li><li>Label<ul><li>Label Selector</li><li>Label: key=value</li></ul></li></ul></li></ul><h2 id=service>Service</h2><ul><li>iptables的DNAT规则(调度多个service后端 ipvs规则)</li><li>靠标签选择器 关联Pod对象</li><li>service 名称 可以被解析(DNS Pod实现解析 - 基础架构级的Pod)<ul><li>基础架构级Pod <code>AddOns</code>集群附加组件 支撑其他服务需要使用到的服务</li><li>动态更新DNS解析</li></ul></li></ul><h2 id=网络通信>网络通信</h2><ul><li>同一个Pod内的多个容器间: lo</li><li>各Pod之间的通信(不直接通信 通过Service通信)<ul><li>二层广播 -> 广播风暴</li><li>Overlay Network 叠加网络<ul><li>需要确保每一个Pod网络地址不会冲突</li></ul></li></ul></li><li>Pod和Service之间的通信</li></ul><p>依赖第三方插件(附件) 通过CNI(容器网络接口)接入</p><ul><li>flannel: 网络配置 Pod网络-10.244.0.0/16</li><li>calico: 网络配置 网络策略(Pod之间、Namespace&mldr;之间的访问或隔离)</li><li>canel: 上面两种搭配使用</li><li>&mldr;</li></ul><p><img src=/p/kubernetes/icons/k8s-network.png width=2156 height=1074 srcset="/p/kubernetes/icons/k8s-network_hu450a176e8d46831d14cdc75349a18d18_2340849_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-network_hu450a176e8d46831d14cdc75349a18d18_2340849_1024x0_resize_box_3.png 1024w" loading=lazy alt=k8s-network class=gallery-image data-flex-grow=200 data-flex-basis=481px></p><h2 id=namespace>Namespace</h2><ul><li>管理的边界</li><li>隔离不同名称空间的网络</li></ul><h2 id=初始化kubernetes集群>初始化Kubernetes集群</h2><p><img src=/p/kubernetes/icons/structure.png width=600 height=498 srcset="/p/kubernetes/icons/structure_hu12b93151174b3e04ef92f8cdd319b528_196054_480x0_resize_box_3.png 480w, /p/kubernetes/icons/structure_hu12b93151174b3e04ef92f8cdd319b528_196054_1024x0_resize_box_3.png 1024w" loading=lazy alt=structure class=gallery-image data-flex-grow=120 data-flex-basis=289px></p><p><img src=/p/kubernetes/icons/k8s-network-structure02.png width=2418 height=1128 srcset="/p/kubernetes/icons/k8s-network-structure02_hu86518e8c49d554475a7b0c3fae4a2e9e_2485545_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-network-structure02_hu86518e8c49d554475a7b0c3fae4a2e9e_2485545_1024x0_resize_box_3.png 1024w" loading=lazy alt=structure02 class=gallery-image data-flex-grow=214 data-flex-basis=514px></p><ul><li><p><a class=link href=https://github.com/kubernetes/kubeadm target=_blank rel=noopener>kubeadm</a></p><ul><li><p>master/nodes: 安装<code>kubetlet</code> <code>kubeadm</code> <code>docker</code></p></li><li><p>master: <code>kubeadm init</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># master init</span>
</span></span><span class=line><span class=cl>sudo kubeadm init <span class=se>\ </span>
</span></span><span class=line><span class=cl>  --kubernetes-version<span class=o>=</span>v1.20.15 <span class=se>\ </span>    <span class=c1># k8s版本</span>
</span></span><span class=line><span class=cl>  --pod-network-cidr<span class=o>=</span>10.244.0.0/16 <span class=se>\ </span> <span class=c1># pod网段</span>
</span></span><span class=line><span class=cl>  --service-cidr<span class=o>=</span>10.96.0.0/12 <span class=se>\ </span>      <span class=c1># service网段</span>
</span></span><span class=line><span class=cl>  --ignore-preflight-errors<span class=o>=</span>Swap      <span class=c1># 忽略预检错误</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>nodes: <code>kubeadm join</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># nodes join</span>
</span></span><span class=line><span class=cl>sudo kubeadm join <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  10.211.55.57:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token hewmhd.fro3dttm001dohys <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:826faddde57dc07d0fbf31e7aa809eb5fc22613787a2fc8ab50f55c4e706cd45
</span></span></code></pre></td></tr></table></div></div></li><li><p>Images</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ilolicon@master:~$ sudo docker image ls
</span></span><span class=line><span class=cl>REPOSITORY                           TAG        IMAGE ID       CREATED         SIZE
</span></span><span class=line><span class=cl>k8s.gcr.io/kube-apiserver            v1.20.15   3ecdeee1255c   <span class=m>7</span> months ago    113MB
</span></span><span class=line><span class=cl>k8s.gcr.io/kube-controller-manager   v1.20.15   403106abce42   <span class=m>7</span> months ago    108MB
</span></span><span class=line><span class=cl>k8s.gcr.io/kube-scheduler            v1.20.15   bfc1b1725466   <span class=m>7</span> months ago    44.1MB
</span></span><span class=line><span class=cl>k8s.gcr.io/kube-proxy                v1.20.15   3c1b1abd329d   <span class=m>7</span> months ago    93.6MB
</span></span><span class=line><span class=cl>k8s.gcr.io/etcd                      3.4.13-0   05b738aa1bc6   <span class=m>24</span> months ago   312MB
</span></span><span class=line><span class=cl>k8s.gcr.io/coredns                   1.7.0      db91994f4ee8   <span class=m>2</span> years ago     42.8MB
</span></span><span class=line><span class=cl>k8s.gcr.io/pause                     3.2        2a060e2e7101   <span class=m>2</span> years ago     484kB  <span class=c1># 创建基础架构容器使用 为Pod提供底层基础结构 无需启动和运行</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h2 id=kuberntes资源概述>Kuberntes资源概述</h2><ul><li>RESTful风格API<ul><li>GET、POST、DELETE、PUT&mldr;</li><li>kubectl run、get、expose、edit&mldr;</li></ul></li><li>资源(对象)<ul><li>workload: Pod、ReplicaSet、Deployment、StatefulSet、DaemonSet、Job、Cronjob&mldr;</li><li>服务发现与均衡: Service、Ingress&mldr;</li><li>配置与存储: Volume、CSI&mldr;<ul><li>ConfigMap、Secret</li><li>DownwardAPI</li></ul></li><li>集群级资源<ul><li>Namespace、Node、Role、ClusterRole、RoleBinding、ClusterRoleBinding</li></ul></li><li>元数据型资源<ul><li>HPA、PodTemplate、LimitRange</li></ul></li></ul></li></ul><h3 id=资源清单定义>资源清单定义</h3><ul><li><p>创建资源的方法</p><ul><li><p>apiserver仅接收json格式的资源定义</p></li><li><p>yaml格式提供配置清单 apiserver可自动将其转换为json格式 而后再提交</p></li></ul></li><li><p>大部分资源的配置清单 主要都有五个主要的部分组成</p><ul><li><p>apiversion</p><ul><li><code>kubectl api-versions</code> # 所属API群组</li><li>标识方式: <code>group/version</code> 省略组名则为core group</li></ul></li><li><p>kind: 资源类别</p></li><li><p>metadata: 元数据</p><ul><li>name: 同一类别中 name需要唯一</li><li>namespace: 所属k8s的哪个名称空间</li><li>labels</li><li>annotations</li><li>每个资源的引用PATH<ul><li><code>/api/${GROUP/VERSION}/namespace/${NAMESPACE}/${TYPE}/${NAME}</code></li></ul></li></ul></li><li><p>spec(重要): 定义用户期望的状态 disired state</p></li><li><p>status: 当前状态 current state 本字段由Kubernetes集群维护</p></li></ul></li><li><p>字段太多 可以借助<code>kubectl explain --help</code>命令查看详细信息</p><ul><li>kubectl explain pod</li><li>kubectl explain pod.metadata</li></ul></li></ul><h3 id=pod概述>Pod概述</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/ target=_blank rel=noopener>pods</a></p><h4 id=自主式pod>自主式Pod</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-demo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/bin/sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;sleep 3600&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=pod资源>Pod资源</h4><ul><li><p>spec.containers &lt;[]object></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># kubectl explain pod.spec.containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>&lt;string&gt; </span><span class=w> </span><span class=c># Always Never IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 修改镜像中的默认应用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>command/args</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>标签</p><ul><li>key = value<ul><li>key: 字母 数字 _ - .</li><li>value: 可以为空 只能字母或数字开头及结尾</li></ul></li></ul></li><li><p>标签选择器</p><ul><li>等值关系: =、==、!=(不等于会筛选出不具有该标签的资源)</li><li>集合关系<ul><li>KEY in (VALUE1,VALUE2,&mldr;)</li><li>KEY notin (VALUE1,VALUE2,&mldr;)</li><li>KEY # 存在这个KEY就行</li><li>!KEY # 不存在此键的资源</li></ul></li></ul></li><li><p>许多资源支持内嵌字段来使用标签选择器</p><ul><li>matchLabels: 直接给定键值</li><li>matchExpressions: 基于给定的表达式来定义使用标签选择器<ul><li>{key: &ldquo;KEY&rdquo;, operator: &ldquo;OPERATOR&rdquo;,values:[VAL1,VAL2,VAL3,&mldr;]</li><li>操作符<ul><li>In、NotIn: values字段的值必须为非空列表</li><li>Exists、NotExists: values字段的值必须为空列表</li></ul></li></ul></li></ul></li><li><p>spec.nodeSelector &lt;map[striong]string></p><ul><li>节点标签选择器</li></ul></li><li><p>spec.nodeName <code>&lt;string></code> # 直接指定运行node</p></li><li><p>annotations</p><ul><li>与label不同的地方在于 它不能用于挑选资源对象 仅用于为对象提供<strong>元数据</strong></li><li>没有键长度/值长度限制</li></ul></li><li><p>spec.restartPolicy</p><ul><li>重启策略: One of Always, OnFailure, Never. Default to Always</li></ul></li></ul><h4 id=pod生命周期>Pod生命周期</h4><ul><li><p>状态</p><ul><li>Pending # 调度尚未完成</li><li>Running # 运行状态</li><li>Failed</li><li>Succeeded</li><li>Unknown</li><li>&mldr;</li></ul></li><li><p>Pod生命周期中的重要行为</p><ul><li>初始化容器</li><li>容器探测(自定义命令/TCP套接字发请求/HTTP应用层请求)<ul><li>liveness probe: 探测容器是否存活</li><li>readiness probe: 探测容器是否准备就绪 能对外提供服务</li></ul></li><li>钩子<ul><li>post start</li><li>pre stop</li></ul></li></ul><p><img src=/p/kubernetes/icons/pod-lifecycle.png width=1802 height=918 srcset="/p/kubernetes/icons/pod-lifecycle_hu63a9e9cf93a88172974cf2b0b759da82_82884_480x0_resize_box_3.png 480w, /p/kubernetes/icons/pod-lifecycle_hu63a9e9cf93a88172974cf2b0b759da82_82884_1024x0_resize_box_3.png 1024w" loading=lazy alt=pod-lifecycle class=gallery-image data-flex-grow=196 data-flex-basis=471px></p></li></ul><h4 id=pod容器探针类型>Pod容器探针类型</h4><p><code>kubectl explain pod.spec.containers.livenessProbe</code></p><p><code>kubectl explain pod.spec.containers.readinessProbe</code></p><ul><li>exec Action</li><li>httpGet Action</li><li>tcpSocket Action</li></ul><h4 id=pod控制器>Pod控制器</h4><ul><li><p>ReplicaSet</p><ul><li>Kubectl explain replicaset</li><li>用户期望副本数 标签选择器 Pod资源模版</li><li>不建议直接使用ReplicaSet</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ReplicaSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>release</span><span class=p>:</span><span class=w> </span><span class=l>canary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>environment</span><span class=p>:</span><span class=w> </span><span class=l>qa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Deployment</p><ul><li>构建在ReplicaSet之上 而非Pod<ul><li>实现滚动更新(多出或少于N个副本 控制更新粒度)、回滚</li><li>通常管理10个历史版本(ReplicaSet)</li></ul></li><li>管理无状态应用最好的控制器</li><li>无状态(只关注群体、不关注个体)、持续运行应用</li><li>声明式管理(即可以创建 也可以更新 <code>kubectl apply -f deployment.yaml</code>)</li><li><code>kubectl rollout history</code> 查看滚动历史</li></ul></li></ul><p><img src=/p/kubernetes/icons/deployment-update.png width=1728 height=566 srcset="/p/kubernetes/icons/deployment-update_hu1b11393a4a96395d8bc44f2effe78eee_1490645_480x0_resize_box_3.png 480w, /p/kubernetes/icons/deployment-update_hu1b11393a4a96395d8bc44f2effe78eee_1490645_1024x0_resize_box_3.png 1024w" loading=lazy alt=deployment-update class=gallery-image data-flex-grow=305 data-flex-basis=732px></p><ul><li><p>DaemonSet</p><ul><li><p><code>kubectl explain deployment.spec.strategy.rollingUpdate</code> # 滚动更新策略</p></li><li><p>确保集群中的每一个节点(或部分满足条件的节点)精确运行一个Pod副本</p></li><li><p>通常用于一些系统级的后台任务</p></li><li><p>无状态、持续运行应用</p></li></ul></li><li><p>Job</p><ul><li>只做一次 只要完成就正常退出 没完成才进行重构</li><li>执行一次性的作业</li><li>不需要持续在后台运行 执行完成就退出</li></ul></li><li><p>Cronjob</p><ul><li>周期性Job</li></ul></li><li><p>StatefulSet</p><ul><li>管理有状态应用</li><li>每一个pod副本单独管理 拥有自己独有的标识和独有的数据集</li></ul></li><li><p>TPR: Third Party Resources 1.2+ - 1.7</p></li><li><p>CDE: Custom Defined Resources 1.8+</p></li><li><p>Operator</p></li></ul><h3 id=service概述>Service概述</h3><h4 id=service代理>Service代理</h4><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/ target=_blank rel=noopener>services-networking</a></p><ul><li>userspace<ul><li>kube-proxy会监视Kubernetes控制平面对Service对象和Endpoints对象的添加和移除操作</li><li>对每个Service它会在本地Node上打开一个端口(随机选择) 任何连接到<strong>代理端口</strong>的请求 都会被代理到Service的后端<code>Pods</code>中的某个上面<ul><li>使用哪个后端Pod是 kube-proxy 基于<code>SessionAffinity</code>来确定的</li></ul></li><li>最后 它配置 iptables 规则 捕获到达该 Service 的<code>clusterIP</code>(是虚拟 IP)和<code>Port</code>的请求 并重定向到代理端口 代理端口再代理请求到后端Pod<ul><li>默认情况下 用户空间模式下的kube-proxy通过轮转算法选择后端</li></ul></li><li>流量来回在内核和用户空间切换 效率较低</li></ul></li></ul><p><img src=/p/kubernetes/icons/services-userspace-overview.svg loading=lazy alt=services-userspace-overview></p><ul><li>iptables<ul><li><p><code>kube-proxy</code>会监视Kubernetes控制节点对Service对象和Endpoints对象的添加和移除</p></li><li><p>对每个Service 它会配置iptables规则 从而捕获到达该Service的<code>clusterIP</code>和端口的请求 进而将请求重定向到 Service 的一组后端中的某个Pod上面</p></li><li><p>对于每个Endpoints对象 它也会配置iptables规则 这个规则会选择一个后端组合</p><ul><li>默认的策略是 kube-proxy在iptables模式下随机选择一个后端</li></ul></li><li><p>使用iptables处理流量具有较低的系统开销 因为流量由Linux netfilter处理 而无需在用户空间和内核空间之间切换 这种方法也可能更可靠</p></li><li><p>如果kube-proxy在iptables模式下运行 并且所选的第一个 Pod 没有响应 则连接失败</p><ul><li>这与用户空间模式不同: 在这种情况下 kube-proxy将检测到与第一个Pod的连接已失败 并会自动使用其他后端Pod 重试</li><li>可以使用Pod<a class=link href=https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/#container-probes target=_blank rel=noopener>就绪探测器</a> 验证后端Pod可以正常工作 以便iptables模式下的kube-proxy仅看到测试正常的后端 避免将流量通过kube-proxy发送到已知已失败的 Pod</li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/services-iptables-overview.svg loading=lazy alt=services-iptables-overview></p><ul><li>ipvs<ul><li><p>特性状态： Kubernetes v1.11 [stable]</p></li><li><p>在<code>ipvs</code>模式下 kube-proxy监视Kubernetes服务和端点 调用<code>netlink</code>接口创建相应的IPVS规则 并定期将IPVS规则与Kubernetes服务和端点同步 该控制循环可确保 IPVS 状态与所需状态匹配</p></li><li><p>访问服务时 IPVS将流量定向到后端Pod之一</p></li><li><p>IPVS代理模式基于类似于iptables模式的netfilter挂钩函数 但是使用哈希表作为基础数据结构 并且在内核空间中工作</p><ul><li>这意味着 与iptables模式下的kube-proxy相比 IPVS模式下的kube-proxy重定向通信的延迟要短 并且在同步代理规则时具有更好的性能</li><li>与其他代理模式相比 IPVS模式还支持更高的网络流量吞吐量</li></ul></li><li><p>IPVS提供了更多选项来平衡后端Pod的流量</p><ul><li><code>rr</code>: 轮询(Round-Robin)</li><li><code>lc</code>: 最少链接(Least Connection) 即打开链接数量最少者优先</li><li><code>dh</code>: 目标地址哈希(Destination Hashing)</li><li><code>sh</code>: 源地址哈希(Source Hashing)</li><li><code>sed</code>: 最短预期延迟(Shortest Expected Delay)</li><li><code>nq</code>: 从不排队(Never Queue)</li></ul></li><li><p>备注</p><ul><li>要在IPVS模式下运行kube-proxy必须在启动kube-proxy之前使IPVS在节点上可用</li><li>当kube-proxy以IPVS代理模式启动时 它将验证IPVS内核模块是否可用<ul><li>如果未检测到IPVS内核模块 则kube-proxy将退回到以iptables代理模式运行</li></ul></li></ul></li></ul></li></ul><p><img src=/p/kubernetes/icons/services-ipvs-overview.svg loading=lazy alt=services-ipvs-overview></p><h4 id=service类型>Service类型</h4><ul><li>ClusterIP: 通过集群的内部IP暴露服务 选择该值时服务只能够在集群内部访问 这也是默认的<code>ServiceType</code></li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#type-nodeport target=_blank rel=noopener>NodePort</a>: 通过每个节点上的IP和静态端口(NodePort)暴露服务 NodePort服务会路由到自动创建的ClusterIP服务<ul><li>通过请求 <code>&lt;节点IP>:&lt;节点端口></code> 你可以从集群的外部访问一个NodePort服务</li><li>Client -> NodeIP:NodePort -> ClusterIP:ServicePort -> PodIP:containerPort</li><li>为避免单Node压力过大 会在外面再加一层负载均衡<ul><li>公有云环境: LBaaS(参考下面LoadBalancer类型)</li></ul></li></ul></li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#loadbalancer target=_blank rel=noopener>LoadBalancer</a>: 使用云提供商的负载均衡器向外部暴露服务 外部负载均衡器可以将流量路由到自动创建的NodePort服务和ClusterIP服务上</li><li><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#externalname target=_blank rel=noopener>ExternalName</a>: 通过返回CNAME和对应值 可以将服务映射到externalName字段的内容(例如<code>foo.bar.example.com</code>) 无需创建任何类型代理<ul><li>FQDN(CoreDNS 内部解析)<ul><li>CNAME -> FQDN(外部真正的FQDN )</li></ul></li></ul></li></ul><h4 id=headless-services无头service>Headless Services(无头Service)</h4><ul><li>有时不需要或不想要负载均衡 以及单独的Service IP 遇到这种情况 可以通过指定Cluster IP(<code>spec.clusterIP</code>)的值为 <code>"None"</code>来创建 <code>Headless</code> Service</li><li>你可以使用一个无头Service与其他服务发现机制进行接口 而不必与Kubernetes的实现捆绑在一起</li><li>对于无头<code>Services</code>并不会分配Cluster IP kube-proxy不会处理它们 而且平台也不会为它们进行负载均衡和路由 DNS如何实现自动配置 依赖于Service是否定义了选择算符</li></ul><h3 id=ingress>Ingress</h3><p><img src=/p/kubernetes/icons/ingress-flow.png width=1182 height=886 srcset="/p/kubernetes/icons/ingress-flow_hu9c99a0266fa357bab5ac86316de97a76_1018969_480x0_resize_box_3.png 480w, /p/kubernetes/icons/ingress-flow_hu9c99a0266fa357bab5ac86316de97a76_1018969_1024x0_resize_box_3.png 1024w" loading=lazy alt=ingress-flow class=gallery-image data-flex-grow=133 data-flex-basis=320px></p><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/ target=_blank rel=noopener>ingress</a></p><ul><li>Service对后端特定类型Pod分类(label selector)</li><li>Ingress基于上面的分类识别后端Pod 并生成配置信息注入到nginx(需要重载配置)/envoy/traefik等</li></ul><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/ target=_blank rel=noopener>ingress-controllers</a></p><h3 id=存储卷>存储卷</h3><p><a class=link href=https://kubernetes.io/zh-cn/docs/concepts/storage/ target=_blank rel=noopener>kubernetes-storage</a></p><p><code>kubectl explain pods.spec.volumes</code></p><ul><li>emptyDir # 临时目录 随pod删除而消失(生命周期同pod)<ul><li>gitRepo(clone到机器 修改不会同步 需要同步可以自己再做一个sidecar)</li></ul></li><li>hostPath # 宿主机路径</li><li>SAN(iSCSI&mldr;)、NAS(nfs、cifs&mldr;)</li><li>分布式存储<ul><li>glusterfs、rdb、cephfs</li></ul></li><li>云存储<ul><li>EBS、Azure Disk&mldr;</li></ul></li></ul><h4 id=pvpvc>PV/PVC</h4><p><img src=/p/kubernetes/icons/pvc.png width=2068 height=1350 srcset="/p/kubernetes/icons/pvc_hufc33b2495877c5db5264e9558db08b3f_2577789_480x0_resize_box_3.png 480w, /p/kubernetes/icons/pvc_hufc33b2495877c5db5264e9558db08b3f_2577789_1024x0_resize_box_3.png 1024w" loading=lazy alt=pvc class=gallery-image data-flex-grow=153 data-flex-basis=367px></p><h4 id=storageclass>StorageClass</h4><ul><li>存储设备需支持RESTful风格的创建请求</li><li>根据请求动态创建PV</li></ul><h4 id=configmap>ConfigMap</h4><ul><li>ConfigMap是一种 API 对象 用来将非机密性的数据保存到键值对中</li><li>使用时<a class=link href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel=noopener>Pods</a>可以将其用作环境变量、命令行参数或者存储卷中的配置文件</li><li>ConfigMap将你的环境配置信息和<a class=link href="https://kubernetes.io/zh-cn/docs/reference/glossary/?all=true#term-image" target=_blank rel=noopener>容器镜像</a>解耦 便于应用配置的修改</li></ul><h5 id=容器化配置应用方式>容器化配置应用方式</h5><ul><li>自定义命令行参数<ul><li>args: []</li></ul></li><li>把配置文件直接打包至镜像</li><li>环境变量<ul><li>CloudNative的应用程序一般可直接通过环境变量加载配置</li><li>通过entrypoint脚本来预处理变量为配置文件中的配置信息</li></ul></li><li>存储卷</li></ul><h4 id=secret>Secret</h4><ul><li>Secret是一种包含少量敏感信息例如密码、令牌或密钥的对象 这样的信息可能会被放在<a class=link href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/ target=_blank rel=noopener>Pod</a>规约中或者镜像中</li><li>使用Secret意味着你不需要在应用程序代码中包含机密数据</li><li>Secret类似于<a class=link href=https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/ target=_blank rel=noopener>ConfigMap</a>但专门用于保存敏感数据</li></ul><h2 id=statefulset控制器>StatefulSet控制器</h2><ul><li><p>CoreOS Operator</p></li><li><p>cattle/pet # 一个关注群体 一个关注个体(和无状态应用的区别)</p></li><li><p>PetSet(1.3) -> StatefulSet(1.5+)</p></li><li><p>StatefulSet主要用于管理有以下特性的应用程序</p><ul><li>稳定且唯一的网络标识符</li><li>稳定且持久的存储</li><li>有序、平滑的部署和扩展</li><li>有序、平滑的终止和删除</li><li>有序的滚动更新</li></ul></li><li><p>一般来说 一个典型的StatefulSet由三个组件组成</p><ul><li>handless service # 无头服务 确保名称唯一</li><li>StatefulSet # 控制器</li><li>volumeClaimTemplate # 存储卷申请模版(不能使用同一存储卷 pod模版创建的存储卷都是一样的 所以需要卷申请模版)</li></ul></li><li><p><code>kubelet explain sts.spec.updateStrategy.rollingUpdate</code></p><ul><li>partition &lt;inter> # 控制更新的Pod</li><li>partition: N # 大于等于编号N的Pod将被更新 默认值: 0</li></ul></li></ul><h2 id=认证及serviceaccount>认证及ServiceAccount</h2><h3 id=认证授权>认证授权</h3><ul><li>认证(支持多种认证方式) # 认证插件<ul><li>令牌认证 bearer token</li><li>ssl认证(确认服务端/客户端身份) 双向证书认证(https)</li><li>&mldr;</li></ul></li><li>授权检查(权限) # 授权插件<ul><li>RBAC # kubeadm部署的集群强制开启RBAC</li><li>&mldr;</li></ul></li><li>准入控制(关联的其他资源或操作 是否有权限 进一步补充授权机制)</li><li>API Server需要信息去识别客户端的操作<ul><li>user: username + uid</li><li>group</li><li>extra</li><li>API(请求的Kubernetes API)<ul><li>Request Path<ul><li><code>kubectl proxy --port=8080</code></li><li><code>curl http://localhost:8080/api/v1/namespaces</code></li><li><code>curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/myapp-deploy/</code></li></ul></li><li>HTTP request verb<ul><li>GET POST PUT DELETE</li><li>get list create update patch watch proxy redirect delete deletecollection</li></ul></li><li>Resources</li><li>SubResources</li><li>Namespace</li><li>API Group</li></ul></li></ul></li></ul><h3 id=serviceaccount>ServiceAccount</h3><ul><li>访问APIServer的两种客户端<ul><li>kubectl/dashborad 集群外部客户端(userAccount)</li><li>pod 集群内部客户端(serviceAccount)<ul><li><code>kubectl explain pods.spec.serviceAccountName</code></li></ul></li></ul></li><li>kubeconfig<ul><li><code>kubectl config view</code></li></ul></li></ul><h3 id=rbac授权>RBAC授权</h3><ul><li>授权插件<ul><li>Node</li><li>ABAC(<em>Attribute-based access control</em>)</li><li>RBAC(<em>Role-based access contro</em>)</li><li>Webhook</li></ul></li></ul><p><img src=/p/kubernetes/icons/k8s-RBAC.png width=1364 height=768 srcset="/p/kubernetes/icons/k8s-RBAC_hu93382d84de46ca6bdd4d6c35df8f4890_1483186_480x0_resize_box_3.png 480w, /p/kubernetes/icons/k8s-RBAC_hu93382d84de46ca6bdd4d6c35df8f4890_1483186_1024x0_resize_box_3.png 1024w" loading=lazy alt=k8s-RBAC class=gallery-image data-flex-grow=177 data-flex-basis=426px></p><ul><li>K8S-RBAC<ul><li>role<ul><li>operations</li><li>objects</li></ul></li><li>rolebinding<ul><li>user account OR service account</li><li>role</li></ul></li><li><code>kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml</code></li></ul></li></ul><p><img src=/p/kubernetes/icons/role-binding.png width=1498 height=1096 srcset="/p/kubernetes/icons/role-binding_hue49744d6898b8c4106d004f8692e3f91_1070895_480x0_resize_box_3.png 480w, /p/kubernetes/icons/role-binding_hue49744d6898b8c4106d004f8692e3f91_1070895_1024x0_resize_box_3.png 1024w" loading=lazy alt=role-binding class=gallery-image data-flex-grow=136 data-flex-basis=328px></p><h2 id=helm>Helm</h2><ul><li>类似yum</li></ul><h2 id=reference>Reference</h2><ul><li>ubuntu</li></ul><p><a class=link href="https://askubuntu.com/questions/428772/how-to-install-specific-version-of-some-package/428778#428778?newreg=d056242a7a0340598dd1d2d4fad63e81" target=_blank rel=noopener>apt install speciffic version</a></p><p><a class=link href=https://www.serverlab.ca/tutorials/containers/docker/how-to-set-the-proxy-for-docker-on-ubuntu/ target=_blank rel=noopener>set-proxy-on-ubuntu-docker</a></p><p><a class=link href=https://askubuntu.com/questions/2493/apt-get-or-aptitude-equivalent-to-yum-whatprovides target=_blank rel=noopener>apt-get-like-yum-whatprovides</a></p><ul><li>kubetnetes</li></ul><p><a class=link href=https://stackoverflow.com/questions/63136175/kubectl-get-componentstatus-shows-unhealthy target=_blank rel=noopener>kubectl-get-commponentstatus-shows-unhealthy</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/cloud-native/>Cloud Native</a>
<a href=/tags/kubernetes/>Kubernetes</a>
<a href=/tags/pod/>Pod</a>
<a href=/tags/service/>Service</a>
<a href=/tags/kubeadm/>Kubeadm</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/prometheus/><div class=article-details><h2 class=article-title>Prometheus</h2></div></a></article><article><a href=/p/docker/><div class=article-details><h2 class=article-title>Docker</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=ilolicon/ilolicon.github.io issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>let utterancesLoaded=!1;function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;utterancesLoaded=!0,setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{if(!utterancesLoaded)return;setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2017 -
2024 ilolicon's Blog</section><section class=powerby>Vicissitude🐳<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>